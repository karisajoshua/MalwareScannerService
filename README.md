# Malware Scanner Service

## Overview

This project provides two implementations of a Windows service that monitors a specified directory for newly created or modified files and scans them for malicious content using predefined signatures and keywords. The project includes implementations in both Python and C#.

## Table of Contents

- [Project Structure](#project-structure)
- [Python Implementation](#python-implementation)
  - [Files](#files)
  - [Setup](#setup)
  - [Code](#code)
- [C# Implementation](#c-implementation)
  - [Files](#files-1)
  - [Setup](#setup-1)
  - [Code](#code-1)
- [Installation and Configuration](#installation-and-configuration)
- [License](#license)

## Project Structure

```
MalwareScannerService/
│
├── src/
│   ├── python/
│   │   ├── malware_scanner_service.py
│   │   ├── signatures.txt
│   │   └── keywords.txt
│   ├── csharp/
│   │   ├── MalwareScannerService.cs
│   │   └── signatures.txt
│   │   └── keywords.txt
│
├── README.md
└── .gitignore
```

## Python Implementation

### Files

- **`src/python/malware_scanner_service.py`**: Contains the code for the Python Windows service.
- **`src/python/signatures.txt`**: Contains malware signatures for scanning files.
- **`src/python/keywords.txt`**: Contains keywords for scanning files.

### Setup

1. **Install Dependencies**

   Ensure you have Python installed. Install the required libraries using pip:

   ```sh
   pip install pywin32 watchdog
   ```

2. **Install the Service**

   To install the service, run the following command from the directory where `malware_scanner_service.py` is located:

   ```sh
   python src/python/malware_scanner_service.py install
   ```

3. **Start the Service**

   Start the service with:

   ```sh
   python src/python/malware_scanner_service.py start
   ```

4. **Stop and Uninstall the Service**

   To stop and uninstall the service:

   ```sh
   python src/python/malware_scanner_service.py stop
   python src/python/malware_scanner_service.py remove
   ```

### Code

#### `src/python/malware_scanner_service.py`

```python
import os
import time
import servicemanager
import win32serviceutil
import win32service
import win32event
from watchdog.observers import Observer
from watchdog.events import FileSystemEventHandler

class MalwareScannerHandler(FileSystemEventHandler):
    def __init__(self, signatures, keywords):
        self.signatures = signatures
        self.keywords = keywords

    def on_created(self, event):
        if not event.is_directory:
            self.scan_file(event.src_path)

    def scan_file(self, file_path):
        try:
            with open(file_path, 'r') as file:
                content = file.read()
                if any(sig in content for sig in self.signatures) or any(kw in content for kw in self.keywords):
                    print(f"Potentially malicious file detected: {file_path}")
        except Exception as e:
            print(f"Error reading file {file_path}: {e}")

class MalwareScannerService(win32serviceutil.ServiceFramework):
    _svc_name_ = "MalwareScannerService"
    _svc_display_name_ = "Malware Scanner Service"
    _svc_description_ = "Scans downloaded files for malware."

    def __init__(self, args):
        win32serviceutil.ServiceFramework.__init__(self, args)
        self.hWaitStop = win32event.CreateEvent(None, 0, 0, None)
        self.observer = Observer()

    def SvcStop(self):
        self.ReportServiceStatus(win32service.SERVICE_STOP_PENDING)
        win32event.SetEvent(self.hWaitStop)
        self.observer.stop()
        self.observer.join()
        self.ReportServiceStatus(win32service.SERVICE_STOPPED)

    def SvcDoRun(self):
        self.ReportServiceStatus(win32service.SERVICE_RUNNING)
        self.run()

    def run(self):
        signatures = self.load_signatures("signatures.txt")
        keywords = self.load_signatures("keywords.txt")
        event_handler = MalwareScannerHandler(signatures, keywords)
        path_to_watch = "C:\\Users\\YourUsername\\Downloads"
        self.observer.schedule(event_handler, path_to_watch, recursive=True)
        self.observer.start()
        while True:
            if win32event.WaitForSingleObject(self.hWaitStop, 5000) == win32event.WAIT_OBJECT_0:
                break

    def load_signatures(self, filename):
        with open(filename, 'r') as file:
            return [line.strip() for line in file]

if __name__ == '__main__':
    win32serviceutil.HandleCommandLine(MalwareScannerService)
```

## C# Implementation

### Files

- **`src/csharp/MalwareScannerService.cs`**: Contains the code for the C# Windows service.
- **`src/csharp/signatures.txt`**: Contains malware signatures for scanning files.
- **`src/csharp/keywords.txt`**: Contains keywords for scanning files.

### Setup

1. **Compile the Program**

   Use Visual Studio or the .NET CLI to build the C# service. Ensure the output executable is accessible.

2. **Install the Service**

   To install the service, run the following command from an elevated command prompt:

   ```sh
   sc create MalwareScannerService binPath= "C:\path\to\your\program.exe"
   ```

3. **Start the Service**

   Start the service with:

   ```sh
   sc start MalwareScannerService
   ```

4. **Stop and Uninstall the Service**

   To stop and uninstall the service:

   ```sh
   sc stop MalwareScannerService
   sc delete MalwareScannerService
   ```

### Code

#### `src/csharp/MalwareScannerService.cs`

```csharp
using System;
using System.IO;
using System.ServiceProcess;
using System.Text;

public class MalwareScannerService : ServiceBase
{
    private FileSystemWatcher watcher;
    private string[] signatures;
    private string[] keywords;

    public MalwareScannerService()
    {
        ServiceName = "MalwareScannerService";
        CanStop = true;
        CanPauseAndContinue = true;
        AutoLog = true;
    }

    protected override void OnStart(string[] args)
    {
        signatures = File.ReadAllLines("signatures.txt");
        keywords = File.ReadAllLines("keywords.txt");

        watcher = new FileSystemWatcher
        {
            Path = @"C:\Users\YourUsername\Downloads",
            NotifyFilter = NotifyFilters.FileName | NotifyFilters.LastWrite,
            Filter = "*.*"
        };

        watcher.Created += OnChanged;
        watcher.Changed += OnChanged;
        watcher.EnableRaisingEvents = true;
    }

    private void OnChanged(object sender, FileSystemEventArgs e)
    {
        ScanFile(e.FullPath);
    }

    private void ScanFile(string filePath)
    {
        try
        {
            string content = File.ReadAllText(filePath);
            foreach (string sig in signatures)
            {
                if (content.Contains(sig))
                {
                    Console.WriteLine($"Potentially malicious file detected: {filePath}");
                    return;
                }
            }

            foreach (string kw in keywords)
            {
                if (content.Contains(kw))
                {
                    Console.WriteLine($"Potentially malicious file detected: {filePath}");
                    return;
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error reading file {filePath}: {ex.Message}");
        }
    }

    protected override void OnStop()
    {
        watcher.EnableRaisingEvents = false;
        watcher.Dispose();
    }

    public static void Main()
    {
        ServiceBase.Run(new MalwareScannerService());
    }
}
```

## Installation and Configuration

1. **Choose the Implementation**: Decide whether to use the Python or C# implementation.
2. **Prepare the Signatures and Keywords**: Modify `signatures.txt` and `keywords.txt` to include your actual malware signatures and keywords.
3. **Follow the Setup Instructions**: Follow the setup instructions provided for the chosen implementation to install and start the service.

## License

This project is licensed under the MIT License. See the [LICENSE](LICENSE) file for details.

---

